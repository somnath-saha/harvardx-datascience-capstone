---
title: "PH125.9x Choose Your Own Project: House Price Prediction"
author: "Somnath Saha"
date: "03/07/2021"
output: 
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\newpage
```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Install and load required packages
if(!require(caret)) install.packages("caret", repos = "http://cran.us.r-project.org")
if(!require(xgboost)) install.packages("xgboost", repos = "http://cran.us.r-project.org")
if(!require(Deriv)) install.packages("Deriv", repos = "http://cran.us.r-project.org")
if(!require(neuralnet)) install.packages("neuralnet", repos = "http://cran.us.r-project.org")

library(caret)
library(dslabs)
library(Deriv)
library(neuralnet)
library(xgboost)
library(tidyverse)

#Read data from CSV file
housedata <- read.csv("cyo-housesale-project/kc_house_data.csv", as.is = TRUE)
```
<!-------------------------------------------------------------------------------------------------------->
# Overview
This project is part of the final course - **Data Science: Capstone** in HarvardX's multi-part **Data Science Professional Certificate** series offered via the edX platform.

The project studies the dataset - **House Sales in King County, USA** available on Kaggle. The different features are studied and its impact evaluated on the pricing. Thus, a house price recommendation system is developed to predict the house prices. 

## About the dataset

The dataset - **House Sales in King County, USA: Predict house price using regression** is taken from Kaggle. \
Kaggle, a subsidiary of Google LLC, is an online community of data scientists and machine learning practitioners. Kaggle allows users to find and publish data sets, explore and build models in a web-based data-science environment, work with other data scientists and machine learning engineers, and enter competitions to solve data science challenges. \
The dataset contains **21613** rows and **21** columns. \
**Go to kaggle page**: *<https://www.kaggle.com/harlfoxem/housesalesprediction>**

## Goal of the project
The goal of the project is to exhaustively study the dataset and get valuable insights through data processing and visualization. Furthermore different ML algorithms are used to train a model that can predict house price.

\newpage

<!-------------------------------------------------------------------------------------------------------->
# Data analysis and visualization

## Brief look at dataset

### Structure of dataset: Column Names & Types
```{r, echo=TRUE, warning=FALSE, message=FALSE}
str(housedata)
```

### Data in dataset: First few rows
```{r, echo=TRUE, warning=FALSE, message=FALSE}
head(housedata)
```

### Unique values in every column
<!-- Find number of unique values in every column -->
```{r, echo=FALSE, warning=FALSE, message=FALSE}
colNames <- colnames(housedata)
sapply(colNames, function(c) {
   n <- n_distinct(housedata[[c]])
}, simplify="array")
```

<!-- Create plot theme to apply to ggplot2 element text throughout report-->
```{r, echo=FALSE, warning=FALSE, message=FALSE}
plot_theme <- theme(plot.caption = element_text(size = 7, face = "italic"), 
                    axis.title = element_text(size = 11))
caption_text <- "PH125.9x | Source: Kaggle KC House Data | Somnath Saha"
```

## Create scatterplot of all the features vs price
```{r, echo=FALSE, warning=FALSE, message=FALSE}
housedata %>%
   gather(-price, key = "var", value = "value") %>%
   ggplot(aes(x = value, y = price)) +
   geom_point(alpha = 0.25, color = lightblue) +
   stat_smooth() +
   facet_wrap(~ var, scales = "free") +
   theme_bw()
```


# Distribution of all the different price of houses (Upto 8M)
housedata %>% ggplot(aes(price)) +
   geom_histogram(binwidth = 100000, color = I("blue"), fill = "skyblue") +
   scale_y_continuous(breaks = seq(0, 4500, 500)) +
   scale_x_continuous(breaks = seq(0, 8000000, 500000), labels = sprintf("%sM", seq(0, 8, 0.5))) +
   labs(x = "Price Range ($)", y = "Number of Houses", caption = caption_text) + plot_theme

# Distribution of the house prices within 1.5M 
housedata %>% filter(price < 1000000) %>% ggplot(aes(price)) +
   geom_histogram(binwidth = 100000, color = I("blue"), fill = "skyblue") +
   scale_y_continuous(breaks = seq(0, 4500, 500)) +
   scale_x_continuous(breaks = seq(0, 1500000, 100000), labels = sprintf("%sK", seq(0, 1500, 100))) +
   labs(x = "Price Range ($)", y = "Number of Houses", caption = caption_text) + plot_theme

# Distribution of all sqft_living values of houses
housedata %>% filter(sqft_living < 10000) %>% ggplot(aes(sqft_living)) +
   geom_histogram(binwidth = 1000, color = I("blue"), fill = "skyblue") +
   scale_x_continuous(breaks = seq(0, 10000, 1000), labels = seq(0, 10000, 1000)) +
   labs(x = "Living Room Size", y = "Count", caption = caption_text) + plot_theme

# Distribution of all sqft_lot values of houses
housedata %>% filter(sqft_lot < 100000) %>% 
   ggplot(aes(sqft_lot)) +
   geom_histogram(binwidth = 10000, color = I("blue"), fill = "skyblue") +
   scale_y_continuous(breaks = seq(0, 20000, 1000)) +
   scale_x_continuous(breaks = seq(0, 100000, 5000), labels = sprintf("%s", seq(0, 10, 0.5))) +
   labs(x = "sqft_lot (In 1000 sqft)", y = "Count", caption = caption_text) + plot_theme

# Distribution of number of houses based on the following column values - 
# 'floors', 'waterfront', 'view', 'condition', 'grade'
grp_col_names <- c('floors', 'waterfront', 'view', 'condition', 'grade')
lapply(grp_col_names, function(c) {
   res <- housedata %>% group_by(.dots = c) %>%  
      summarise('Count' = n(), Percentage = n() * 100 / nrow(housedata)) %>%
      arrange(desc(Percentage))
   res %>% ggplot(aes_string(x=c, y='Count')) + 
      geom_bar(stat = "identity", color = I("white"), fill = "skyblue") +
      geom_text(aes_string(label='Count'), position=position_dodge(width=0.75), vjust=-0.3) +
      labs(x = c, y = "Count", caption = caption_text) + plot_theme
})

# Distribution of number of houses based on the following column values - 'yr_built', 'yr_renovated'
grp_col_names_yr <- c('yr_built', 'yr_renovated')
lapply(grp_col_names_yr, function(c) {
   res <- housedata %>% group_by(.dots = c) %>%  
      summarise('Count' = n(), Percentage = n() * 100 / nrow(housedata)) %>%
      arrange(desc(Percentage)) %>% top_n(10)
   res
})

# Influence of number of bedrooms on the price of house 
housedata %>% filter(bedrooms < 15) %>% ggplot(aes(x=bedrooms, y=price, group=bedrooms)) +
   geom_boxplot() +
   scale_x_continuous(breaks = seq(0, 15, 1)) +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "No of Bedrooms", y = "Price of House ($)", caption = caption_text) + plot_theme

# Influence of number of bathrooms on the price of house 
housedata %>% ggplot(aes(x=bathrooms, y=price, group=bathrooms)) +
   geom_boxplot() +
   scale_x_continuous(breaks = seq(0, 15, 1)) +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "No of Bathrooms", y = "Price of House ($)", caption = caption_text) + plot_theme

# Influence of number of sqft_living on the price of house 
housedata %>% filter(sqft_living < 7500) %>% ggplot(aes(x=sqft_living, y=price, group=sqft_living)) +
   geom_boxplot() +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "sqft_living", y = "Price of House ($)", caption = caption_text) + plot_theme

# Influence of number of sqft_lot on the price of house 
housedata %>% ggplot(aes(x=sqft_lot, y=price, group=sqft_lot)) +
   geom_boxplot() +
   scale_x_continuous(breaks = seq(0, 15, 1)) +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "sqft_lot", y = "Price of House ($)", caption = caption_text) + plot_theme

# Influence of number of floors on the price of house 
housedata %>% ggplot(aes(x=floors, y=price, group=floors)) +
   geom_boxplot() +
   scale_x_continuous(breaks = seq(0, 15, 1)) +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "floors", y = "Price of House ($)", caption = caption_text) + plot_theme

# Influence of number of waterfront on the price of house 
housedata %>% ggplot(aes(x=waterfront, y=price, group=waterfront)) +
   geom_boxplot() +
   scale_x_continuous(breaks = seq(0, 15, 1)) +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "waterfront", y = "Price of House ($)", caption = caption_text) + plot_theme

# Influence of view on the price of house 
housedata %>% ggplot(aes(x=view, y=price, group=view)) +
   geom_boxplot() +
   scale_x_continuous(breaks = seq(0, 15, 1)) +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "view", y = "Price of House ($)", caption = caption_text) + plot_theme

# Influence of condition on the price of house 
housedata %>% ggplot(aes(x=condition, y=price, group=condition)) +
   geom_boxplot() +
   scale_x_continuous(breaks = seq(0, 15, 1)) +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "condition", y = "Price of House ($)", caption = caption_text) + plot_theme

# Influence of grade on the price of house 
housedata %>% ggplot(aes(x=grade, y=price, group=grade)) +
   geom_boxplot() +
   scale_x_continuous(breaks = seq(0, 15, 1)) +
   scale_y_continuous(breaks = seq(0, 8000000, 1000000), labels = sprintf("%sM", seq(0, 8, 1))) +
   labs(x = "grade", y = "Price of House ($)", caption = caption_text) + plot_theme

# Study sqft_living vs. sqft_living15
cor(housedata$sqft_living, housedata$sqft_living15)
housedata %>%
   ggplot(aes(x = sqft_living, y = sqft_living15)) +
   geom_point(color = "blue", alpha=0.25) +
   stat_smooth() +
   theme_bw()

# Study sqft_lot vs. sqft_lot15
cor(housedata$sqft_lot, housedata$sqft_lot15)
housedata %>%
   ggplot(aes(x = sqft_lot15, y = sqft_lot)) +
   geom_point(color = "blue", alpha=0.5) +
   stat_smooth() +
   theme_bw()

# ========================================================================================
# Analyze and train different models to predict house price
# ========================================================================================

# Report the outliers as observed from data visualization
housedata %>% filter(sqft_living < 7500) %>% summarise(n = n(), percent = n / nrow(housedata))
housedata %>% filter(bedrooms < 15) %>% summarise(n = n(), percent = n / nrow(housedata)) 

# Drop the columns not required for training
housedata <- housedata %>% select(-id, -date, -sqft_living15, -sqft_lot15)

# Cut the continuous data values for the different areas in sqft
housedata <- housedata %>% filter(sqft_living < 7500 && bedrooms < 15) %>% 
   mutate(sqft_living = as.numeric(cut(sqft_living, 100)), sqft_lot = as.numeric(cut(sqft_lot, 1000)),
          sqft_above = as.numeric(cut(sqft_above, 100)), sqft_basement = as.numeric(cut(sqft_basement, 100)),
          lat = as.numeric(cut(lat, 1000)), long = as.numeric(cut(long, 100)))

# Convert necessary columns into factors
col_names_for_factor <- c('bedrooms' ,'bathrooms', "floors", "waterfront", "view", "condition", "grade", "zipcode")
housedata[,col_names_for_factor] <- lapply(housedata[,col_names_for_factor] , factor)

# Convert necessary columns into factors
str(housedata)

# Divide dataset into training and validation dataset
test_index <- createDataPartition(y = housedata$price, times = 1, p = 0.1, list = FALSE)
hdata_train <- housedata[-test_index,]
hdata_validation <- housedata[test_index,]

# Train for the following models
models <- c("lm", "glm", "gbm", "knn", "gamLoess")
fits <- lapply(models, function(model) { 
   print(model)
   train(price ~ ., method = model, data = hdata_train)
}) 

# Predict values on the validation set
pred <- sapply(fits, function(object) predict(object, newdata = validation))

# Define and find the RMSE values for the results
RMSE <- function (x, test) sqrt(mean((x-test$price)^2))
res <- lapply(pred, FUN = RMSE, hdata_validation)

# Comparison with a naive model of predicting value with mean
mu <- mean(housedata$price)
   


<!-------------------------------------------------------------------------------------------------------->
# Conclusions
The MovieRecommenderModel developed predicts values on the validation set with an RMSE of `r final_rmse_validation_set`. The model includes the movie, user, genre, release year and review year effects along with regularization.

<!-------------------------------------------------------------------------------------------------------->
# References

[1] Introduction to Data Science, Rafael A. Irizarry \
[2] http://www.sthda.com/english/wiki/qplot-quick-plot-with-ggplot2-r-software-and-data-visualization \
[3] https://bookdown.org/yihui/rmarkdown-cookbook/kable.html \
[4] https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet \
[5] https://www.kaggle.com
[6] https://en.wikipedia.org/wiki/Kaggle

\newpage
<!-------------------------------------------------------------------------------------------------------->

